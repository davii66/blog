[{"content":"\n\n前几天安装NextCloud的时候发现了一个响应头:Referrer-Policy，仔细研究一番后发现他可以让目前流行的referrer防盗链机制几乎失效。这里给个栗子。\n\n## Demo1\n这是QQ空间的图片。抓包可以看到实际上地址相同，唯一的区别是`referrerpolicy=\"no-referrer\"`。\n\u003cimg style=\"margin:auto\" referrerpolicy=\"no-referrer\" src=\"http://m.qpic.cn/psb?/46015da3-1d58-4f01-88e1-accc164c4516/gzvOEXqtRJFkCxQZjAPLFUN4FM29KaOKs7Bi1KlabvE!/b/dL8AAAAAAAAA\u0026bo=dwAzAAAAAAADB2Y!\u0026rf=viewer_4\"\u003e\n\u003cimg style=\"margin:auto\" src=\"http://m.qpic.cn/psb?/46015da3-1d58-4f01-88e1-accc164c4516/gzvOEXqtRJFkCxQZjAPLFUN4FM29KaOKs7Bi1KlabvE!/b/dL8AAAAAAAAA\u0026bo=dwAzAAAAAAADB2Y!\u0026rf=viewer_4?abcd\"\u003e\n## Demo2 （流量巨大注意）\n这里盗链了一个网盘（个人网盘，看他啥时候倒闭）作为视频播放源。\n\u003cbr/\u003e\n\u003cbutton onclick=\"document.getElementById('ys').innerHTML=document.getElementById('ys-b').value\"\u003e\n视频盗链(成功)\n\u003c/button\u003e\u003cbutton onclick=\"document.getElementById('ys').innerHTML=document.getElementById('ys-c').value\"\u003e\n视频盗链(失败)\n\u003c/button\u003e\n\n\u003ctextarea style=\"display:none\" id=\"ys-b\"\u003e\u003ciframe referrerpolicy=\"no-referrer\" frameborder=\"0\" style=\"width:330px;height:190px;\" src=\"data:text/html;base64,PG1ldGEgbmFtZT1yZWZlcnJlciBjb250ZW50PW5ldmVyPjx2aWRlbyB3aWR0aD0zMDBweCBjb250cm9scyBzcmM9aHR0cDovL2YuZTEyMy5wdy9mdWNrLXhteXAvZ3VybC5waHA/cGF0aD03NDY0Mjk3My0xLTExMi5tcDQ+PC92aWRlbz4=\"\u003e\u003c/iframe\u003e\u003c/textarea\u003e\n\u003ctextarea style=\"display:none\" id=\"ys-c\"\u003e\u003cvideo width=\"300px\" referrerpolicy=\"no-referrer\" controls src=\"http://f.e123.pw/fuck-xmyp/gurl.php?path=74642973-1-112.mp4\"\u003e\u003c/video\u003e\u003c/textarea\u003e\n\u003cdiv id=\"ys\"\u003e\u003c/div\u003e\n\n查看源码可以发现，盗链成功的视频位于一个iframe中。iframe的src是dataurl，实际内容是：\n```html\n\u003cmeta name=referrer content=never\u003e\n\u003cvideo width=300px controls src=视频地址\u003e\u003c/video\u003e\n```\n## 原理\n\n\u003eReferrer Policy（引用策略）就是从一个文档发出请求时，是否在请求头部定义 Referrer 的设置。\n\n这里就得提到一个HTTP协议中的拼写错误：浏览器发送的请求头是`Referer`，实际上是`Referrer`，HTTP协议中少了一个`r`但是在其他处均已更正。\n\nreferrer-policy分为新旧两个标准。IE,Edge,iOS仅支持旧标准，其余大部分浏览器都支持新标准。旧标准通常被向下兼容。\n\n![浏览器支持情况](/images/referrer-caniuse.png)\n## 标准\n\nReferrer-Policy本意是保护隐私，\u003cdel\u003e并不是破解防盗链\u003c/del\u003e。新标准支持以下几个属性:\n\n - `\"\"`(空字符串，大部分浏览器处理为no-referrer-when-downgrade)\n - `no-referrer` 永不发送\n - `no-referrer-when-downgrade` HTTPS-\u003eHTTP不发送\n - `same-origin` 跨域不发送\n - `origin` (只发送origin,协议+域名+端口)\n - `strict-origin` (HTTPS-\u003eHTTP不发送，否则发送origin)\n - `origin-when-cross-origin` (跨域只发送origin)\n - `strict-origin-when-cross-origin` (HTTPS-\u003eHTTP不发送，跨域只发送origin)\n - `unsafe-url` (全部发送)\n \n旧标准支持以下几个属性：\n\n - `default` 等同于 `\"\"`\n - `never` 等同于 `no-referrer`\n - `always` 等同于 `unsafe-url`\n\n支持的设置方式：\n\n - 服务端设置header `Referrer-Policy:no-referrer`\n - HTML Head 中放置Meta标签 `\u003cmeta name=referrer content=no-referrer\u003e`\n - `\u003ca\u003e` `\u003cimg\u003e` `\u003ciframe\u003e`标签（目前已知）支持`referrerpolicy=\"no-referrer\"`属性\n - `\u003ca\u003e`标签还支持`rel=\"noreferrer\"`属性。\n\n\u003e旧标准通常只在Meta标签中被支持。\n\n## 进一步防盗链\n可能基于URL的Token防盗链是唯一方案？但好像配合服务端爬虫也可以破解。解决方案仍等待寻找...","cover":"/images/referrer.jpg","link":"referrer-policy-hotlink.html","preview":"\u003cp\u003e前几天安装NextCloud的时候发现了一个响应头:Referrer-Policy，仔细研究一番后发现他可以让目前流行的referrer防盗链机制几乎失效。这里给个栗子。\u003c/p\u003e\n","title":"Referrer-Policy与Referrer防盗链"},{"content":"\n\nhashover默认使用mail函数发送邮件，一般情况我们无法收到。因此，我们要引入smtp库解决邮件问题。\n\n![](/images/hashover.png)\n## SMTP发送邮件\n\u003e使用的SMTP库的Github地址：[https://github.com/swt83/php-smtp](https://github.com/swt83/php-smtp)。\n这个库使用composer安装依赖，改造不方便，可以下载我修改的文件：[\u003esmtp.php.zip\u003c](/attachments/smtp.php.zip)\n\n下载smtp库后，放在hashover的scripts目录下。接下来，修改配置文件`settings.php`，将下面代码放到`public$notificationEmail`之上：\n\n```php\n//SMTP Settings\n    public $smtp_host    = \"smtp.exmail.qq.com\";//SMTP服务器\n    public $smtp_port    = \"465\";       //smtp端口\n    public $smtp_encrypt = \"ssl\";       //是否启用加密,null或者'ssl'\n    public $smtp_user    = \"i@ye4.pw\";      //发件邮箱\n    public $smtp_pass    = \"********\";      //密码\n    public $smtp_name    = \"Weng's Blog\";   //博客名称，hashover没提供接口\n    public $smtp_sender    = \"某翁的信使\";  //发信人昵称\n    //模板，兼容Wordpress插件Comment Reply Notification。\n    public $smtp_title   = \"Hi，您在《[postname]》的评论被回复啦！\";\n    public $smtp_tpl     = \u003c\u003c\u003cEOT\n\u003cdiv style=\"-moz-border-radius: 5px;-webkit-border-radius: 5px;-khtml-border-radius: 5px;border-radius: 5px;background-color:white;border-top:2px solid #1bb565;box-shadow:0 1px 3px #AAAAAA;line-height:180%;padding:0 15px 12px;width:500px;margin:50px auto;color:#555555;font-family:Century Gothic,Trebuchet MS,Hiragino Sans GB,微软雅黑,Microsoft Yahei,Tahoma,Helvetica,Arial,SimSun,sans-serif;font-size:12px;\"\u003e\n\t\u003ch2 style=\"border-bottom:1px solid #DDD;font-size:14px;font-weight:normal;padding:13px 0 10px 8px;\"\u003e\n\t\u003cspan style=\"color: #1bb565;font-weight: bold;\"\u003e\u003e\u003c/span\u003e\n\t您在 \u003ca style=\"text-decoration:none;color: #1bb565;\" href=\"[blogurl]\" target=\"_blank\"\u003e[blogname]\u003c/a\u003e 博客上的留言有回复啦！\u003c/h2\u003e\n\t\u003cdiv style=\"padding:0 12px 0 12px;margin-top:18px\"\u003e\n\t\t\u003cp\u003e亲爱的 [pc_author]， 您好！您曾在文章《[postname]》上发表评论：\u003c/p\u003e\n\t\t\u003cp style=\"background-color: #f5f5f5;border: 0px solid #DDD;padding: 10px 15px;margin:18px 0\"\u003e[pc_comment]\u003c/p\u003e\n\t\t\u003cp\u003e[cc_author]给您的回复如下：\u003c/p\u003e\n\t\t\u003cp style=\"background-color: #f5f5f5;border: 0px solid #DDD;padding: 10px 15px;margin:18px 0\"\u003e[cc_comment]\u003c/p\u003e\n\t\t\u003cp\u003e您可以点击\u003ca href=\"[cc_url]\"\u003e查看回复的完整内容\u003c/a\u003e，欢迎再次光临\u003ca href=\"[blogurl]\"\u003e[blogname]\u003c/a\u003e 。\u003c/p\u003e\n\t\u003c/div\u003e\n\u003c/div\u003e\nEOT;\n\t//有任何新评论管理员都会收到邮件的模板。\n    public $smtp_admin_title   = \"[blogname]: 文章《[postname]》有新评论\";\n    public $smtp_admin_tpl     = \u003c\u003c\u003cEOT\n\u003cdiv style=\"-moz-border-radius: 5px;-webkit-border-radius: 5px;-khtml-border-radius: 5px;border-radius: 5px;background-color:white;border-top:2px solid #1bb565;box-shadow:0 1px 3px #AAAAAA;line-height:180%;padding:0 15px 12px;width:500px;margin:50px auto;color:#555555;font-family:Century Gothic,Trebuchet MS,Hiragino Sans GB,微软雅黑,Microsoft Yahei,Tahoma,Helvetica,Arial,SimSun,sans-serif;font-size:12px;\"\u003e\n\t\u003ch2 style=\"border-bottom:1px solid #DDD;font-size:14px;font-weight:normal;padding:13px 0 10px 8px;\"\u003e\n\t\u003cspan style=\"color: #1bb565;font-weight: bold;\"\u003e\u003e\u003c/span\u003e\n\t文章 \u003ca style=\"text-decoration:none;color: #1bb565;\" href=\"[cc_url]\" target=\"_blank\"\u003e[postname]\u003c/a\u003e 有新评论啦！\u003c/h2\u003e\n\t\u003cdiv style=\"padding:0 12px 0 12px;margin-top:18px\"\u003e\n\t\t\u003cp\u003e[cc_author] 说：\u003c/p\u003e\n\t\t\u003cp style=\"background-color: #f5f5f5;border: 0px solid #DDD;padding: 10px 15px;margin:18px 0\"\u003e[cc_comment]\u003c/p\u003e\n\t\u003c/div\u003e\n\u003c/div\u003e\nEOT;\n```\n随后，打开`writecomments.php`，找到`writeComment`函数，将其中两处和下面一样的代码注释掉。（防止回复者邮箱被发给被回复者）\n```php\n$from_line .= ' \u003c' . $this-\u003eemail . '\u003e';\n```\n找到第一个`mail`函数，注释掉，并在下方加上smtp发送代码：\n```php\n//mail ($reply_email, $this-\u003esetup-\u003edomain . ' - New Reply', $reply_message, $this-\u003euserHeaders);\n//被注释掉的mail函数\n$urls=parse_url($this-\u003esetup-\u003epageURL);\n$smtp_config=array(\n    'debug_mode' =\u003e false,\n    'default' =\u003e 'primary',\n    'connections' =\u003e [\n        'primary' =\u003e [\n        'host' =\u003e $this-\u003esetup-\u003esmtp_host,\n        'port' =\u003e $this-\u003esetup-\u003esmtp_port,\n        'secure' =\u003e $this-\u003esetup-\u003esmtp_encrypt,\n        'auth' =\u003e true,\n        'user' =\u003e $this-\u003esetup-\u003esmtp_user,\n        'pass' =\u003e $this-\u003esetup-\u003esmtp_pass,\n        ],\n    ],\n    'localhost' =\u003e $this-\u003esetup-\u003edomain,\n);\n$mail=new smtp($smtp_config);\n$mail-\u003eto($reply_email);\n$mail-\u003efrom($this-\u003esetup-\u003esmtp_user,$this-\u003esetup-\u003esmtp_sender);\n$mail-\u003esubject(str_replace(array(\n    \"[blogname]\",\n    \"[blogurl]\",\n    \"[postname]\",\n    \"[pc_date]\",\n    \"[pc_comment]\",\n    \"[pc_author]\",\n    \"[cc_date]\",\n    \"[cc_comment]\",\n    \"[cc_author]\",\n    \"[cc_url]\"\n),array(\n    $this-\u003esetup-\u003esmtp_name,\n    $urls[\"sheme\"].\"://\".$urls[\"host\"].isset($parsed_url['port']) ? ':' . $parsed_url['port'] : '',\n    html_entity_decode($this-\u003esetup-\u003epageTitle),\n    $reply_comment['date'],\n    $reply_comment['body'],\n    $reply_name,\n    $this-\u003ecommentData['date'],\n    $this-\u003ecommentData['body'],\n    $from_line,\n    $this-\u003esetup-\u003epageURL. '#' . $permalink\n),$this-\u003esetup-\u003esmtp_title));\n$mail-\u003ebody(str_replace(array(\n    \"[blogname]\",\n    \"[blogurl]\",\n    \"[postname]\",\n    \"[pc_date]\",\n    \"[pc_comment]\",\n    \"[pc_author]\",\n    \"[cc_date]\",\n    \"[cc_comment]\",\n    \"[cc_author]\",\n    \"[cc_url]\"\n),array(\n    $this-\u003esetup-\u003esmtp_name,\n    $urls[\"sheme\"].\"://\".$urls[\"host\"].isset($parsed_url['port']) ? ':' . $parsed_url['port'] : '',\n    $this-\u003esetup-\u003epageTitle,\n    $reply_comment['date'],\n    $reply_comment['body'],\n    $reply_name,\n    $this-\u003ecommentData['date'],\n    $this-\u003ecommentData['body'],\n    $from_line,\n    $this-\u003esetup-\u003epageURL. '#' . $permalink\n),$this-\u003esetup-\u003esmtp_tpl));\n$result = $mail-\u003esend();\n```\n再往下找到第二个mail函数，注释，加上提醒管理员的代码：\n```php\n//mail ($this-\u003esetup-\u003enotificationEmail, 'New Comment', $webmaster_message, $this-\u003eheaders);$urls=parse_url($this-\u003esetup-\u003epageURL);\n//被注释掉的mail函数\n$smtp_config=array(\n    'debug_mode' =\u003e false,\n    'default' =\u003e 'primary',\n    'connections' =\u003e [\n        'primary' =\u003e [\n            'host' =\u003e $this-\u003esetup-\u003esmtp_host,\n            'port' =\u003e $this-\u003esetup-\u003esmtp_port,\n            'secure' =\u003e $this-\u003esetup-\u003esmtp_encrypt,\n            'auth' =\u003e true,\n            'user' =\u003e $this-\u003esetup-\u003esmtp_user,\n            'pass' =\u003e $this-\u003esetup-\u003esmtp_pass,\n        ],\n    ],\n    'localhost' =\u003e $this-\u003esetup-\u003edomain,\n);\n$mail=new smtp($smtp_config);\n$mail-\u003eto($this-\u003esetup-\u003enotificationEmail);\n$mail-\u003efrom($this-\u003esetup-\u003esmtp_user,$this-\u003esetup-\u003esmtp_sender);\n$mail-\u003esubject(str_replace(array(\n    \"[blogname]\",\n    \"[blogurl]\",\n    \"[postname]\",\n    \"[cc_date]\",\n    \"[cc_comment]\",\n    \"[cc_author]\",\n    \"[cc_url]\"\n),array(\n    $this-\u003esetup-\u003esmtp_name,\n    $urls[\"sheme\"].\"://\".$urls[\"host\"].isset($parsed_url['port']) ? ':' . $parsed_url['port'] : '',\n    html_entity_decode($this-\u003esetup-\u003epageTitle),\n    $this-\u003ecommentData['date'],\n    $this-\u003ecommentData['body'],\n    $from_line,\n    $this-\u003esetup-\u003epageURL. '#' . $permalink\n),$this-\u003esetup-\u003esmtp_admin_title));\n$mail-\u003ebody(str_replace(array(\n    \"[blogname]\",\n    \"[blogurl]\",\n    \"[postname]\",\n    \"[cc_date]\",\n    \"[cc_comment]\",\n    \"[cc_author]\",\n    \"[cc_url]\"\n),array(\n    $this-\u003esetup-\u003esmtp_name,\n    $urls[\"sheme\"].\"://\".$urls[\"host\"].isset($parsed_url['port']) ? ':' . $parsed_url['port'] : '',\n    html_entity_decode($this-\u003esetup-\u003epageTitle),\n    $this-\u003ecommentData['date'],\n    $this-\u003ecommentData['body'],\n    $from_line,\n    $this-\u003esetup-\u003epageURL. '#' . $permalink\n),$this-\u003esetup-\u003esmtp_admin_tpl));\n$result = $mail-\u003esend();\n```\n保存，接下来应该就能收到邮件了。注意，自己回自己不会发送。\n\n\u003e本博客已修改，可就地评论体验效果。不过因测试导致发送大量邮件，本博客使用的邮箱被qq邮箱拦截，截止发布本文时尚未恢复，并不代表该功能失效。\n\n### 懒人包（`smtp.php+writecomments.php`）：[\u003ehashover-smtp.zip\u003c](/attachments/hashover-smtp-pack.zip)\n\n## 几个魔改想法（List）：\n* （完成）  完善邮件功能\n* （准备写文章）加上表情包\n* （实现中）加上显示地区和UA\n* （不可能）加上评论等级\n* （实现中）在不启用密码的情况下做评论管理\n\n如果真能实现，这个系统就万能了（才不是呢）。","cover":"/images/hashover.png","link":"hashover-smtp.html","preview":"\u003cp\u003ehashover默认使用mail函数发送邮件，一般情况我们无法收到。因此，我们要引入smtp库解决邮件问题。\u003c/p\u003e\n","title":"hashover系列第二篇：SMTP发邮件"},{"content":"\n\u003e[limitPNG](http://nullice.com/limitPNG/) 支持无损压缩和有损压缩两种压缩方式，其中无损压缩是不损失任何画质的压缩方法，与有损压缩相比（如 tinypng），虽然体积没优势，但是在对品质有要求的生产环境中不改变原图任何一个像素是必须的。\n\n增加Web版本后，使用更加简便。\n\n![](/images/limitpng.png)\n[limitPNG](http://nullice.com/limitPNG/)原版使用的是`Electron`，这也就意味着原版代码只要去掉UI部分并暴露API接口就可以在NodeJS环境下运行。前端代码使用`Vue`，将打开文件的函数更换为`Webuploader`并将处理部分及其回调函数更改为API调用。\n\n\u003eGithub开源地址：[https://github.com/homeii/limitpng-online](https://github.com/homeii/limitpng-online)\n\n### 附录：limit极限无损压图算法\n非常的简单...其他算法可在`limitpng.js`中获得\n```shell\nTruePNG  文件名\npngout  文件名\npngwolf --in=文件名 --out=文件名\nzopflipng -m -y 文件名  文件名\n```","cover":"/images/limitpng.png","link":"limitpng-online.html","preview":"\u003cblockquote\u003e\n\u003cp\u003e\u003ca href=\"http://nullice.com/limitPNG/\"\u003elimitPNG\u003c/a\u003e 支持无损压缩和有损压缩两种压缩方式，其中无损压缩是不损失任何画质的压缩方法，与有损压缩相比（如 tinypng），虽然体积没优势，但是在对品质有要求的生产环境中不改变原图任何一个像素是必须的。\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003e增加Web版本后，使用更加简便。\u003c/p\u003e\n","title":"移植无损压图工具LimitPNG到web端"},{"content":"\n\n第三方评论的战场上，多说倒下了，云跟帖倒下了，disqus连接受阻，剩下搜狐畅言和几个小平台摇摇欲坠...\n无论如何，这时候还是自建评论系统最可靠。这里要讲的就是目前比较成熟的hashover。\n\n![](/images/hashover.png)\n## 下载\u0026安装\n\u003eGithub地址：[https://github.com/jacobwb/hashover-next](https://github.com/jacobwb/hashover-next)\n\n直接打包下载解压到服务器即可。随后，按照里面的提示修改`hashover/scripts/settings.php`，即可直接使用。\n\n## 探坑\n虽然现在hashover已经可以正常运行，但其实还存在有很多坑。下面是我踩到的部分。\n\n### PDO错误\n在选择mysql并填好数据库信息后出现了这样的错误提示：`HashOver:PDO.php file could not be included!`，\n原因是某个地方PDO类忘了加根命名空间。目前这个问题已经有人提交了PR，官方合并之前我们可以自己先改一下。\n\n`hashover/scripts/parsesql.php`\n```php\nLine 76  在PDO前面加上“\\”\n$fetchAll = $results-\u003efetchAll (\\PDO::FETCH_NUM);\n\nLine 111 同理\nreturn (array) $result-\u003efetch (\\PDO::FETCH_ASSOC);\n```\n### AJAX跨域问题\n当在配置文件启用ajax模式的时候，你会发现所有请求全部失败了。\n因为hashover并没有对跨域访问进行处理（加cors头），所以请求被浏览器拦截。\n\n可在`hashover/scripts/settings.php`顶部加入代码或者用Nginx/apache进行配置。\n```php\nheader(\"Access-Control-Allow-Origin:\".(isset($_SERVER['HTTP_ORIGIN'])?$_SERVER['HTTP_ORIGIN']:\"*\"));\nheader(\"Access-Control-Allow-Credentials:true\");\n```\n### 不保存用户信息问题\n前文说过hashover并没有对跨域访问进行处理，所以只加cors头无法保存cookies。\n解决方法是在`hashover/scripts/javascript-mode.php`中查找`XMLHttpRequest`\n并给所有的XHR对象全部加上`withCredentials=true`。\n## 美化（魔改）\nHashOver提供一个主题机制，可以在`hashover/themes`各个主题的文件夹中修改`layout.html`和`style.css`来自定义样式。\n具体魔改例子可看本站评论区，也可自己下载本站CSS。\n### 几个魔改想法（尚未实现）：\n* 加上表情包\n* 加上显示地区和UA\n* 加上评论等级\n* 在不启用密码的情况下做评论管理\n* 魔改成弹幕系统的后端\n\n如果真能实现，这个系统就万能了（才不是呢）。","cover":"/images/hashover.png","link":"hashover.html","preview":"\u003cp\u003e第三方评论的战场上，多说倒下了，云跟帖倒下了，disqus连接受阻，剩下搜狐畅言和几个小平台摇摇欲坠\u0026hellip;\n无论如何，这时候还是自建评论系统最可靠。这里要讲的就是目前比较成熟的hashover。\u003c/p\u003e\n","title":"使用\u0026魔改hashover评论系统"},{"content":"\n没错，又是我。这次又把博客推翻重做了一遍，换了最简单的静态博客。\n\n不忘初心，方得始终。\n\n程序用的是`纸小墨`，看中的是他只要带着一个exe就可以随便跑，不需要像其他博客系统一样装环境....此外这也是第一次尝试markdown吧...\n\n","cover":"/images/example-en.png","link":"new-start.html","preview":"\u003cp\u003e没错，又是我。这次又把博客推翻重做了一遍，换了最简单的静态博客。\u003c/p\u003e\n\n\u003cp\u003e不忘初心，方得始终。\u003c/p\u003e\n","title":"MyBlog新的开始"}]