[{"content":"\r\n\r\nhashover默认使用mail函数发送邮件，一般情况我们无法收到。因此，我们要引入smtp库解决邮件问题。\r\n\r\n![](/images/hashover.png)\r\n## SMTP发送邮件\r\n\u003e使用的SMTP库的Github地址：[https://github.com/swt83/php-smtp](https://github.com/swt83/php-smtp)。\r\n这个库使用composer安装依赖，改造不方便，可以下载我修改的文件：[\u003esmtp.php.zip\u003c](/attachments/smtp.php.zip)\r\n\r\n下载smtp库后，放在hashover的scripts目录下。接下来，修改配置文件`settings.php`，将下面代码放到`public$notificationEmail`之上：\r\n\r\n```php\r\n//SMTP Settings\r\n    public $smtp_host    = \"smtp.exmail.qq.com\";//SMTP服务器\r\n    public $smtp_port    = \"465\";       //smtp端口\r\n    public $smtp_encrypt = \"ssl\";       //是否启用加密,null或者'ssl'\r\n    public $smtp_user    = \"i@ye4.pw\";      //发件邮箱\r\n    public $smtp_pass    = \"********\";      //密码\r\n    public $smtp_name    = \"Weng's Blog\";   //博客名称，hashover没提供接口\r\n    public $smtp_sender    = \"某翁的信使\";  //发信人昵称\r\n    //模板，兼容Wordpress插件Comment Reply Notification。\r\n    public $smtp_title   = \"Hi，您在《[postname]》的评论被回复啦！\";\r\n    public $smtp_tpl     = \u003c\u003c\u003cEOT\r\n\u003cdiv style=\"-moz-border-radius: 5px;-webkit-border-radius: 5px;-khtml-border-radius: 5px;border-radius: 5px;background-color:white;border-top:2px solid #1bb565;box-shadow:0 1px 3px #AAAAAA;line-height:180%;padding:0 15px 12px;width:500px;margin:50px auto;color:#555555;font-family:Century Gothic,Trebuchet MS,Hiragino Sans GB,微软雅黑,Microsoft Yahei,Tahoma,Helvetica,Arial,SimSun,sans-serif;font-size:12px;\"\u003e\r\n\t\u003ch2 style=\"border-bottom:1px solid #DDD;font-size:14px;font-weight:normal;padding:13px 0 10px 8px;\"\u003e\r\n\t\u003cspan style=\"color: #1bb565;font-weight: bold;\"\u003e\u003e\u003c/span\u003e\r\n\t您在 \u003ca style=\"text-decoration:none;color: #1bb565;\" href=\"[blogurl]\" target=\"_blank\"\u003e[blogname]\u003c/a\u003e 博客上的留言有回复啦！\u003c/h2\u003e\r\n\t\u003cdiv style=\"padding:0 12px 0 12px;margin-top:18px\"\u003e\r\n\t\t\u003cp\u003e亲爱的 [pc_author]， 您好！您曾在文章《[postname]》上发表评论：\u003c/p\u003e\r\n\t\t\u003cp style=\"background-color: #f5f5f5;border: 0px solid #DDD;padding: 10px 15px;margin:18px 0\"\u003e[pc_comment]\u003c/p\u003e\r\n\t\t\u003cp\u003e[cc_author]给您的回复如下：\u003c/p\u003e\r\n\t\t\u003cp style=\"background-color: #f5f5f5;border: 0px solid #DDD;padding: 10px 15px;margin:18px 0\"\u003e[cc_comment]\u003c/p\u003e\r\n\t\t\u003cp\u003e您可以点击\u003ca href=\"[cc_url]\"\u003e查看回复的完整内容\u003c/a\u003e，欢迎再次光临\u003ca href=\"[blogurl]\"\u003e[blogname]\u003c/a\u003e 。\u003c/p\u003e\r\n\t\u003c/div\u003e\r\n\u003c/div\u003e\r\nEOT;\r\n\t//有任何新评论管理员都会收到邮件的模板。\r\n    public $smtp_admin_title   = \"[blogname]: 文章《[postname]》有新评论\";\r\n    public $smtp_admin_tpl     = \u003c\u003c\u003cEOT\r\n\u003cdiv style=\"-moz-border-radius: 5px;-webkit-border-radius: 5px;-khtml-border-radius: 5px;border-radius: 5px;background-color:white;border-top:2px solid #1bb565;box-shadow:0 1px 3px #AAAAAA;line-height:180%;padding:0 15px 12px;width:500px;margin:50px auto;color:#555555;font-family:Century Gothic,Trebuchet MS,Hiragino Sans GB,微软雅黑,Microsoft Yahei,Tahoma,Helvetica,Arial,SimSun,sans-serif;font-size:12px;\"\u003e\r\n\t\u003ch2 style=\"border-bottom:1px solid #DDD;font-size:14px;font-weight:normal;padding:13px 0 10px 8px;\"\u003e\r\n\t\u003cspan style=\"color: #1bb565;font-weight: bold;\"\u003e\u003e\u003c/span\u003e\r\n\t文章 \u003ca style=\"text-decoration:none;color: #1bb565;\" href=\"[cc_url]\" target=\"_blank\"\u003e[postname]\u003c/a\u003e 有新评论啦！\u003c/h2\u003e\r\n\t\u003cdiv style=\"padding:0 12px 0 12px;margin-top:18px\"\u003e\r\n\t\t\u003cp\u003e[cc_author] 说：\u003c/p\u003e\r\n\t\t\u003cp style=\"background-color: #f5f5f5;border: 0px solid #DDD;padding: 10px 15px;margin:18px 0\"\u003e[cc_comment]\u003c/p\u003e\r\n\t\u003c/div\u003e\r\n\u003c/div\u003e\r\nEOT;\r\n```\r\n随后，打开`writecomments.php`，找到`writeComment`函数，将其中两处和下面一样的代码注释掉。（防止回复者邮箱被发给被回复者）\r\n```php\r\n$from_line .= ' \u003c' . $this-\u003eemail . '\u003e';\r\n```\r\n找到第一个`mail`函数，注释掉，并在下方加上smtp发送代码：\r\n```php\r\n//mail ($reply_email, $this-\u003esetup-\u003edomain . ' - New Reply', $reply_message, $this-\u003euserHeaders);\r\n//被注释掉的mail函数\r\n$urls=parse_url($this-\u003esetup-\u003epageURL);\r\n$smtp_config=array(\r\n    'debug_mode' =\u003e false,\r\n    'default' =\u003e 'primary',\r\n    'connections' =\u003e [\r\n        'primary' =\u003e [\r\n        'host' =\u003e $this-\u003esetup-\u003esmtp_host,\r\n        'port' =\u003e $this-\u003esetup-\u003esmtp_port,\r\n        'secure' =\u003e $this-\u003esetup-\u003esmtp_encrypt,\r\n        'auth' =\u003e true,\r\n        'user' =\u003e $this-\u003esetup-\u003esmtp_user,\r\n        'pass' =\u003e $this-\u003esetup-\u003esmtp_pass,\r\n        ],\r\n    ],\r\n    'localhost' =\u003e $this-\u003esetup-\u003edomain,\r\n);\r\n$mail=new smtp($smtp_config);\r\n$mail-\u003eto($reply_email);\r\n$mail-\u003efrom($this-\u003esetup-\u003esmtp_user,$this-\u003esetup-\u003esmtp_sender);\r\n$mail-\u003esubject(str_replace(array(\r\n    \"[blogname]\",\r\n    \"[blogurl]\",\r\n    \"[postname]\",\r\n    \"[pc_date]\",\r\n    \"[pc_comment]\",\r\n    \"[pc_author]\",\r\n    \"[cc_date]\",\r\n    \"[cc_comment]\",\r\n    \"[cc_author]\",\r\n    \"[cc_url]\"\r\n),array(\r\n    $this-\u003esetup-\u003esmtp_name,\r\n    $urls[\"sheme\"].\"://\".$urls[\"host\"].isset($parsed_url['port']) ? ':' . $parsed_url['port'] : '',\r\n    html_entity_decode($this-\u003esetup-\u003epageTitle),\r\n    $reply_comment['date'],\r\n    $reply_comment['body'],\r\n    $reply_name,\r\n    $this-\u003ecommentData['date'],\r\n    $this-\u003ecommentData['body'],\r\n    $from_line,\r\n    $this-\u003esetup-\u003epageURL. '#' . $permalink\r\n),$this-\u003esetup-\u003esmtp_title));\r\n$mail-\u003ebody(str_replace(array(\r\n    \"[blogname]\",\r\n    \"[blogurl]\",\r\n    \"[postname]\",\r\n    \"[pc_date]\",\r\n    \"[pc_comment]\",\r\n    \"[pc_author]\",\r\n    \"[cc_date]\",\r\n    \"[cc_comment]\",\r\n    \"[cc_author]\",\r\n    \"[cc_url]\"\r\n),array(\r\n    $this-\u003esetup-\u003esmtp_name,\r\n    $urls[\"sheme\"].\"://\".$urls[\"host\"].isset($parsed_url['port']) ? ':' . $parsed_url['port'] : '',\r\n    $this-\u003esetup-\u003epageTitle,\r\n    $reply_comment['date'],\r\n    $reply_comment['body'],\r\n    $reply_name,\r\n    $this-\u003ecommentData['date'],\r\n    $this-\u003ecommentData['body'],\r\n    $from_line,\r\n    $this-\u003esetup-\u003epageURL. '#' . $permalink\r\n),$this-\u003esetup-\u003esmtp_tpl));\r\n$result = $mail-\u003esend();\r\n```\r\n再往下找到第二个mail函数，注释，加上提醒管理员的代码：\r\n```php\r\n//mail ($this-\u003esetup-\u003enotificationEmail, 'New Comment', $webmaster_message, $this-\u003eheaders);$urls=parse_url($this-\u003esetup-\u003epageURL);\r\n//被注释掉的mail函数\r\n$smtp_config=array(\r\n    'debug_mode' =\u003e false,\r\n    'default' =\u003e 'primary',\r\n    'connections' =\u003e [\r\n        'primary' =\u003e [\r\n            'host' =\u003e $this-\u003esetup-\u003esmtp_host,\r\n            'port' =\u003e $this-\u003esetup-\u003esmtp_port,\r\n            'secure' =\u003e $this-\u003esetup-\u003esmtp_encrypt,\r\n            'auth' =\u003e true,\r\n            'user' =\u003e $this-\u003esetup-\u003esmtp_user,\r\n            'pass' =\u003e $this-\u003esetup-\u003esmtp_pass,\r\n        ],\r\n    ],\r\n    'localhost' =\u003e $this-\u003esetup-\u003edomain,\r\n);\r\n$mail=new smtp($smtp_config);\r\n$mail-\u003eto($this-\u003esetup-\u003enotificationEmail);\r\n$mail-\u003efrom($this-\u003esetup-\u003esmtp_user,$this-\u003esetup-\u003esmtp_sender);\r\n$mail-\u003esubject(str_replace(array(\r\n    \"[blogname]\",\r\n    \"[blogurl]\",\r\n    \"[postname]\",\r\n    \"[cc_date]\",\r\n    \"[cc_comment]\",\r\n    \"[cc_author]\",\r\n    \"[cc_url]\"\r\n),array(\r\n    $this-\u003esetup-\u003esmtp_name,\r\n    $urls[\"sheme\"].\"://\".$urls[\"host\"].isset($parsed_url['port']) ? ':' . $parsed_url['port'] : '',\r\n    html_entity_decode($this-\u003esetup-\u003epageTitle),\r\n    $this-\u003ecommentData['date'],\r\n    $this-\u003ecommentData['body'],\r\n    $from_line,\r\n    $this-\u003esetup-\u003epageURL. '#' . $permalink\r\n),$this-\u003esetup-\u003esmtp_admin_title));\r\n$mail-\u003ebody(str_replace(array(\r\n    \"[blogname]\",\r\n    \"[blogurl]\",\r\n    \"[postname]\",\r\n    \"[cc_date]\",\r\n    \"[cc_comment]\",\r\n    \"[cc_author]\",\r\n    \"[cc_url]\"\r\n),array(\r\n    $this-\u003esetup-\u003esmtp_name,\r\n    $urls[\"sheme\"].\"://\".$urls[\"host\"].isset($parsed_url['port']) ? ':' . $parsed_url['port'] : '',\r\n    html_entity_decode($this-\u003esetup-\u003epageTitle),\r\n    $this-\u003ecommentData['date'],\r\n    $this-\u003ecommentData['body'],\r\n    $from_line,\r\n    $this-\u003esetup-\u003epageURL. '#' . $permalink\r\n),$this-\u003esetup-\u003esmtp_admin_tpl));\r\n$result = $mail-\u003esend();\r\n```\r\n保存，接下来应该就能收到邮件了。注意，自己回自己不会发送。\r\n\r\n\u003e本博客已修改，可就地评论体验效果。不过因测试导致发送大量邮件，本博客使用的邮箱被qq邮箱拦截，截止发布本文时尚未恢复，并不代表该功能失效。\r\n\r\n### 懒人包（`smtp.php+writecomments.php`）：[\u003ehashover-smtp.zip\u003c](/attachments/hashover-smtp-pack.zip)\r\n\r\n## 几个魔改想法（List）：\r\n* （完成）  完善邮件功能\r\n* （准备写文章）加上表情包\r\n* （实现中）加上显示地区和UA\r\n* （不可能）加上评论等级\r\n* （实现中）在不启用密码的情况下做评论管理\r\n\r\n如果真能实现，这个系统就万能了（才不是呢）。","cover":"/images/hashover.png","link":"hashover-smtp.html","preview":"\u003cp\u003ehashover默认使用mail函数发送邮件，一般情况我们无法收到。因此，我们要引入smtp库解决邮件问题。\u003c/p\u003e\n","title":"hashover系列第二篇：SMTP发邮件"},{"content":"\r\n\u003e[limitPNG](http://nullice.com/limitPNG/) 支持无损压缩和有损压缩两种压缩方式，其中无损压缩是不损失任何画质的压缩方法，与有损压缩相比（如 tinypng），虽然体积没优势，但是在对品质有要求的生产环境中不改变原图任何一个像素是必须的。\r\n\r\n增加Web版本后，使用更加简便。\r\n\r\n![](/images/limitpng.png)\r\n[limitPNG](http://nullice.com/limitPNG/)原版使用的是`Electron`，这也就意味着原版代码只要去掉UI部分并暴露API接口就可以在NodeJS环境下运行。前端代码使用`Vue`，将打开文件的函数更换为`Webuploader`并将处理部分及其回调函数更改为API调用。\r\n\r\n\u003eGithub开源地址：[https://github.com/homeii/limitpng-online](https://github.com/homeii/limitpng-online)\r\n\r\n### 附录：limit极限无损压图算法\r\n非常的简单...其他算法可在`limitpng.js`中获得\r\n```shell\r\nTruePNG  文件名\r\npngout  文件名\r\npngwolf --in=文件名 --out=文件名\r\nzopflipng -m -y 文件名  文件名\r\n```","cover":"/images/limitpng.png","link":"limitpng-online.html","preview":"\u003cblockquote\u003e\n\u003cp\u003e\u003ca href=\"http://nullice.com/limitPNG/\"\u003elimitPNG\u003c/a\u003e 支持无损压缩和有损压缩两种压缩方式，其中无损压缩是不损失任何画质的压缩方法，与有损压缩相比（如 tinypng），虽然体积没优势，但是在对品质有要求的生产环境中不改变原图任何一个像素是必须的。\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003e增加Web版本后，使用更加简便。\u003c/p\u003e\n","title":"移植无损压图工具LimitPNG到web端"},{"content":"\r\n\r\n第三方评论的战场上，多说倒下了，云跟帖倒下了，disqus连接受阻，剩下搜狐畅言和几个小平台摇摇欲坠...\r\n无论如何，这时候还是自建评论系统最可靠。这里要讲的就是目前比较成熟的hashover。\r\n\r\n![](/images/hashover.png)\r\n## 下载\u0026安装\r\n\u003eGithub地址：[https://github.com/jacobwb/hashover-next](https://github.com/jacobwb/hashover-next)\r\n\r\n直接打包下载解压到服务器即可。随后，按照里面的提示修改`hashover/scripts/settings.php`，即可直接使用。\r\n\r\n## 探坑\r\n虽然现在hashover已经可以正常运行，但其实还存在有很多坑。下面是我踩到的部分。\r\n\r\n### PDO错误\r\n在选择mysql并填好数据库信息后出现了这样的错误提示：`HashOver:PDO.php file could not be included!`，\r\n原因是某个地方PDO类忘了加根命名空间。目前这个问题已经有人提交了PR，官方合并之前我们可以自己先改一下。\r\n\r\n`hashover/scripts/parsesql.php`\r\n```php\r\nLine 76  在PDO前面加上“\\”\r\n$fetchAll = $results-\u003efetchAll (\\PDO::FETCH_NUM);\r\n\r\nLine 111 同理\r\nreturn (array) $result-\u003efetch (\\PDO::FETCH_ASSOC);\r\n```\r\n### AJAX跨域问题\r\n当在配置文件启用ajax模式的时候，你会发现所有请求全部失败了。\r\n因为hashover并没有对跨域访问进行处理（加cors头），所以请求被浏览器拦截。\r\n\r\n可在`hashover/scripts/settings.php`顶部加入代码或者用Nginx/apache进行配置。\r\n```php\r\nheader(\"Access-Control-Allow-Origin:\".(isset($_SERVER['HTTP_ORIGIN'])?$_SERVER['HTTP_ORIGIN']:\"*\"));\r\nheader(\"Access-Control-Allow-Credentials:true\");\r\n```\r\n### 不保存用户信息问题\r\n前文说过hashover并没有对跨域访问进行处理，所以只加cors头无法保存cookies。\r\n解决方法是在`hashover/scripts/javascript-mode.php`中查找`XMLHttpRequest`\r\n并给所有的XHR对象全部加上`withCredentials=true`。\r\n## 美化（魔改）\r\nHashOver提供一个主题机制，可以在`hashover/themes`各个主题的文件夹中修改`layout.html`和`style.css`来自定义样式。\r\n具体魔改例子可看本站评论区，也可自己下载本站CSS。\r\n### 几个魔改想法（尚未实现）：\r\n* 加上表情包\r\n* 加上显示地区和UA\r\n* 加上评论等级\r\n* 在不启用密码的情况下做评论管理\r\n* 魔改成弹幕系统的后端\r\n\r\n如果真能实现，这个系统就万能了（才不是呢）。","cover":"/images/hashover.png","link":"hashover.html","preview":"\u003cp\u003e第三方评论的战场上，多说倒下了，云跟帖倒下了，disqus连接受阻，剩下搜狐畅言和几个小平台摇摇欲坠\u0026hellip;\n无论如何，这时候还是自建评论系统最可靠。这里要讲的就是目前比较成熟的hashover。\u003c/p\u003e\n","title":"使用\u0026魔改hashover评论系统"},{"content":"\r\n没错，又是我。这次又把博客推翻重做了一遍，换了最简单的静态博客。\r\n\r\n不忘初心，方得始终。\r\n\r\n程序用的是`纸小墨`，看中的是他只要带着一个exe就可以随便跑，不需要像其他博客系统一样装环境....此外这也是第一次尝试markdown吧...\r\n\r\n","cover":"/images/example-en.png","link":"new-start.html","preview":"\u003cp\u003e没错，又是我。这次又把博客推翻重做了一遍，换了最简单的静态博客。\u003c/p\u003e\n\n\u003cp\u003e不忘初心，方得始终。\u003c/p\u003e\n","title":"MyBlog新的开始"}]